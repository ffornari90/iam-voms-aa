version: "3.7"

volumes:
  data:
  trustanchors:
  cabundle:
  certs:
  binaries:

services:
  sidecar:
    image: ffornari/iam-binaries:latest
    container_name: sidecar

    volumes:
      - binaries:/opt/bin

  trust:
    image: ffornari/trustanchors:latest
    container_name: trust
    hostname: trust
    volumes:
      - trustanchors:/etc/grid-security/certificates
      
  hostcert:
    image: ffornari/hostcert:latest
    container_name: hostcert
    hostname: hostcert
    links:
      - "trust:trust"

    command: /bin/bash -c "
        echo $$HOST_PRIVATE_KEY | base64 -d | tee /etc/ssl/certs/hostkey.pem
        && curl \"$${HOST_CERT_URL}\" -o /etc/ssl/certs/hostcert.pem
        && /opt/bin/wait-for-it.sh -t 0 trust:8086
        && cp /etc/grid-security/certificates/*.pem /etc/pki/ca-trust/source/anchors/
        && update-ca-trust
        && echo '# GEANT eScience Personal CA 4' | tee -a /etc/pki/tls/certs/ca-bundle.crt
        && cat /etc/grid-security/certificates/GEANTeSciencePersonalCA4.pem | tee -a /etc/pki/tls/certs/ca-bundle.crt
        && nc -l 8085
      "

    environment:
      HOST_PRIVATE_KEY: ${IAM_HOST_KEY}
      HOST_CERT_URL: ${IAM_HOST_CERT}

    volumes:
      - trustanchors:/etc/grid-security/certificates
      - cabundle:/etc/pki
      - certs:/etc/ssl/certs
      - binaries:/opt/bin

    depends_on:
      - sidecar

  db:
    container_name: db
    hostname: db
    image: mysql:5.7
    volumes:
      - data:/var/lib/mysql
    
    environment:
      TZ: Europe/Rome
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PWD:-pwd}
      MYSQL_USER: ${MYSQL_USERNAME:-iam}
      MYSQL_PASSWORD: ${MYSQL_PWD:-pwd}
      MYSQL_DATABASE: ${MYSQL_DB:-iam}

  iam-be:
    image: indigoiam/iam-login-service:${IAM_VERSION:-v1.6.0}
    container_name: iam-be
    hostname: iam-be
    links:
      - "db:db"

    command: /bin/bash -c "
        /opt/bin/wait-for-it.sh -t 0 db:3306
        && if [[ $$IAM_VERS =~ \"v1.6.\" ]]; then java $$IAM_JAVA_MEM_OPTS $$IAM_JAVA_OPTS -jar iam-login-service.war;
         elif [[ $$IAM_VERS =~ \"v1.7.\" ]]; then java $$IAM_JAVA_MEM_OPTS $$IAM_JAVA_OPTS -jar iam-login-service.war;
         elif [[ $$IAM_VERS =~ \"v1.8.\" ]]; then java $$IAM_JAVA_OPTS org.springframework.boot.loader.WarLauncher;
         else echo 'IAM version '$$IAM_VERS' is not available'; fi
      "

    environment: 
      TZ: Europe/Rome
      IAM_JAVA_OPTS: -Djava.security.egd=file:/dev/./urandom -Xdebug -Xrunjdwp:server=y,transport=dt_socket,suspend=n,address=1044 -Dspring.profiles.active=prod,registration
      IAM_JAVA_MEM_OPTS: -XX:MaxRAMFraction=1 -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap
      IAM_VERS: ${IAM_VERSION:-v1.6.0}
      IAM_HOST: ${IAM_FQDN:-iam-indigo.cr.cnaf.infn.it}
      IAM_BASE_URL: ${IAM_URL:-https://iam-indigo.cr.cnaf.infn.it}
      IAM_ISSUER: ${IAM_ISSUER:-https://iam-indigo.cr.cnaf.infn.it}
      IAM_USE_FORWARDED_HEADERS: "true"
      IAM_NOTIFICATION_DISABLE: "true"
      IAM_DB_HOST: ${MYSQL_DB:-db}
      IAM_DB_USERNAME: ${MYSQL_USERNAME:-iam}
      IAM_DB_PASSWORD: ${MYSQL_PWD:-pwd}
  
    volumes:
      - binaries:/opt/bin

    depends_on:
      - sidecar

  client:
    image: indigoiam/iam-test-client:latest
    container_name: client
    hostname: client
    environment:
      IAM_CLIENT_PORT: 8080
    
  iam:
    image: indigoiam/nginx:latest
    container_name: iam
    hostname: iam
    links:
      - "hostcert:hostcert"
      - "iam-be:iam-be"
      - "client:client"

    command: /bin/bash -c "
        cp /certs/hostcert.pem /etc/ssl/certs/iam.cert.pem
        && cp /certs/hostkey.pem /etc/ssl/private/iam.key.pem
        && /opt/bin/wait-for-it.sh -t 0 hostcert:8085
        && /opt/bin/wait-for-it.sh -t 0 iam-be:8080
        && /opt/bin/wait-for-it.sh -t 0 client:8080
        && nginx -g 'daemon off;'
      "

    volumes:
      - certs:/certs
      - binaries:/opt/bin

    environment:
      TZ: Europe/Rome

    ports:
      - "443:443"
      - "80:80"
    
    depends_on:
      - sidecar

  nginx-voms:
    image: storm2/ngx-voms:latest
    container_name: nginx-voms
    links:
      - "iam:iam"
      - "vomsng:vomsng"

    command: /bin/bash -c "
        cp /opt/bin/nginx.conf /home/build/local/openresty/nginx/conf/
        && cp /opt/bin/voms-ng.conf /etc/nginx/conf.d/voms-ng.template
        && envsubst '$${IAM_HOST}' < /etc/nginx/conf.d/voms-ng.template > /etc/nginx/conf.d/srm.conf
        && /opt/bin/wait-for-it.sh -t 0 iam:443
        && /home/build/local/openresty/nginx/sbin/nginx -g 'daemon off;'
      "

    ports:
      - "15000:443"

    environment:
      TZ: UTC
      X509_VOMS_DIR: /vomsdir
      IAM_HOST: ${IAM_FQDN:-iam-indigo.cr.cnaf.infn.it}
      

    volumes:
      - cabundle:/etc/pki
      - trustanchors:/etc/grid-security/certificates
      - certs:/certs
      - binaries:/opt/bin
      
    depends_on:
      - sidecar

  vomsng:
    image: indigoiam/voms-aa:latest
    hostname: ${IAM_FQDN:-iam-indigo.cr.cnaf.infn.it}
    links:
      - "iam-be:iam-be"

    entrypoint:
      /bin/sh -c "
        cp /opt/bin/application.yml /app/resources/
        && /opt/bin/wait-for-it.sh -t 0 iam-be:8080
        && java -cp @/app/jib-classpath-file it.infn.mw.voms.VomsService
      "

    environment:
      TZ: Europe/Rome
      IAM_HOST: ${IAM_FQDN:-iam-indigo.cr.cnaf.infn.it}
      IAM_DB_HOST: ${MYSQL_DB:-db}
      IAM_DB_USERNAME: ${MYSQL_USERNAME:-iam}
      IAM_DB_PASSWORD: ${MYSQL_PWD:-pwd}
    
    ports:
      - "9444:15000"

    volumes:
      - certs:/etc/grid-security/voms
      - trustanchors:/etc/grid-security/certificates
      - binaries:/opt/bin

    depends_on:
      - sidecar
